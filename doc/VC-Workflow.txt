-----------------------------------------
---- Volume Cartographer v2.5   ---------
-----------------------------------------
  
  
==== Step 0: Package ====================
All samples must be packaged into our volume package format. If you do not yet 
have a volume package, you can package your slice images using the following 
command:  
  
  vc_packager --slices [slices path] --volpkg [id name]  
      or  
  vc_packager -s [slices path] -v [id name]  
  
  
  
==== Step 1: Segmentation using VC ======
The first step in the unwrapping pipeline is layer segmentation. This is the 
process of isolating a single layer or piece of a layer from the rest of volume. 
This is accomplished in the VC gui app by manually tracing a starting path on a 
layer and propagating that path forward through the volume.  
  
Open the VC gui app and load your volume package using "File->Open Volume..." 
Navigate to and select the ".volpkg" folder generated by Step 0 and click Open. 
After the volume package loads, the slice images from the volume will be shown 
in the Image Viewer in the middle of the screen. These images can be navigated 
using the Previous and Next Slice buttons or the Slice ID box just below the 
Image Viewer. To use the Slice ID box, type a slice ID number into the box and 
press Enter.  
  
To the right of the Image Viewer are the Volume, Segmentation, and Editing 
control panels. The Volume panel lists the individual segmentations currently in 
the volume package. The Segmentation and Editing panels show options and 
parameters for their respective tasks.  
  
---- Create a new segmentation ----------
In the Volume panel, select the New button to add an empty segmentation to the 
volume package. In the Image Viewer, navigate to the slice image on which you 
want to begin segmentation. Select the Pen Tool button at the top of the screen 
to enter Drawing mode. In Drawing mode, trace the layer you wish to segment by 
clicking to place path control points on the layer. Place at least three path 
control points, making sure to place the points closer to the middle of the 
layer rather than towards either edge. After you have drawn your path, click 
the Pen Tool button again to exit Drawing mode. Your starting path will be 
automatically saved to the volume package.  
  
---- Running segmentation ---------------
To being propagating a segmentation, first click the Segmentation Tool button 
above the Image Viewer to enter Segmentation Mode. The parameters and options 
for segmentation are found to the right of the Image Viewer in the Segmentation 
panel.  
  
Currently there is only one algorithm available for segmentation, Local Reslice 
Particle Simulation (LRPS). This algorithm treats the starting path as a 
connected chain of particles inside of the volume. At each iteration, the chain 
propagates forward through the volume and each particle in the chain attempts to 
reposition itself such that it stays situated in the middle of the layer being 
followed.  
  
The following are the parameters for LRPS:  
  Distance Weight (0-100) [default: 50]:  
      Weighting for distance vs maxima intensity as % of influence. Lower values 
      favor new particle positions that are closer to the previous position. 
      Higher values favor particle positions that have brighter intensity
      values.  
  Maxima Window Width (in voxels) [default: auto]:  
      The width of the reslice window used by each particle to determine its 
      next position. This value is automatically determined by the 
      materialthickness and voxelsize metadata stored in the volume package.  
  Curvature Metrics: Alpha, Beta, and Delta should sum to 1.0  
    - Alpha [default: 0.333]:  
        Coefficient of internal energy metric.  
    - Beta [default: 0.333]:  
        Coefficient for curve tension energy metric.  
    - Delta [default: 0.333]:  
        Coefficient for curvature energy metric.  
  Internal Energy Coeffecients: K1 and K2 should sum to 1.0  
    - K1 [default: 0.5]:  
        Coefficient for first derivative term in internal energy metric.  
    - K2 [default: 0.5]:  
        Coefficient for second derivative term in internal energy metric.  
  Consider Previous [default: disabled]:  
      When enabled, the particle's previous position in the XY plane is
      considered as a candidate for optimization. Useful when a layer is not 
      visible within the local region or there is significant amount of high 
      intensity noise.  

The following are the parameters for all propagation-based algorithms:  
  Starting Slice:  
    The slice on which propagation of the path will begin. This is locked to 
    match the slice that is currently visible in the Image Viewer.  
  Ending Slice:  
    The slice on which propagation of the path will end. This value must be 
    greater than Starting Slice and defaults to the current slice number + 5.  

After adjusting the segmentation parameters, press the Start button in the 
Segmentation panel to begin automatic segmentation. Depending on the size of the 
volume, the length of the path, and the number of slices being segmented, this 
process may take while. Please be patient and know that a progress bar is 
coming soon. When segmentation is complete, the app will leave Segmentation mode 
(the Segmentation Tool will be unselected) and "Segmentation complete" will be 
displayed in the status bar at the bottom of the screen. Navigate through the 
slices using the Image Viewer controls to review the results of segmentation. If 
no editing is required on the results, navigate forward through the volume to 
the previously entered Ending Slice, enter Segmentation mode, and repeat the 
steps above.  
  
---- Editing a segmentation -------------
After running automatic segmentation, it is often necessary to adjust the 
results in order to fix errors in the segmentation process where points do not 
track the correct layer. VC features a simple, click-and-drag point editor to in 
order to improve segmentation results.  
  
To begin, navigate through your segmentation to the slice on which the error 
begins to occur and select the Segmentation Tool to enter Segmentation Mode. 
In the Image Viewer, click and drag the points that have moved or look like 
they're about to move off of the layer. As when drawing your starting path, try 
to position points in the middle of the desired layer.  
  
Points adjacent to the selected point will also be moved in order to keep a 
smooth path. To increase or decrease the number of adjacent points affected by 
this feature, adjust the Impact Range slider in the Editing panel to the right 
of the Image Viewer. The Show Curve checkbox below the Image Viewer will turn 
off the segmentation path to allow for an unobstructed view of the layers.  
  
After all adjustments have been made, make any desired changes to the 
segmentation parameters in the Segmentation panel as described in "Running 
segmentation", and click the Start button to continue path propagation.  
  
NOTE: The LRPS algorithm is a forward propagation segmentation algorithm where 
the results of the later iterations are directly dependent on the earlier 
iterations. When editing segmentations, this means that making corrections in 
the middle of a propagation invalidates the results for slices that follow the 
one on which corrections are made. After making corrections and clicking Start, 
any previously computed segmentation information that follows the new Starting 
Slice will be recomputed.  
  
  
  
==== Step 2: Render using VC-Texture ====
After segmenting a layer using VC, the second stage of the unwrapping pipeline 
is rendering. Rendering is the process of using a segmentation in conjuction 
with the volume in order create an image that shows the text on the surface of a 
layer. Rendering is performed in the VC-Texture gui app.  
  
Open the VC-Texture gui app and load your volume package using 
"File->Open Volume..." Navigate to and select the ".volpkg" folder generated by 
Step 0 and click Open. After the volume package loads, the first segmentation in 
the volume package will be automatically selected. If a rendering for this 
segmentation has been previously computed, it will be shown in the Texture 
Viewer in the middle of the screen.  
  
The Volume Package panel is to the right of the Texture Viewer and lists the 
segmentations in the volume package. The Rendering panel is below that and shows 
the rendering parameters.  
  
In the rendering process, a 3D neighborhood is constructed around every point on 
the mesh and the voxels within that neighborhood are filtered to produce a 
single intensity value. This intensity value is assigned to the point as its 
texture intensity.  
  
The following are the parameters for rendering:

  Radius (0-inf) [default: 0]:  
      The radius, in voxels, of the neighbordhood filtered by the rendering 
      process. The neighborhood is aligned along the vector that is normal to 
      the surface of the segmentation at the considered point. The radius is the 
      maximum extent of the neighbordhood along this normal.
  Texture Method: The method by which the neighborhood is filtered
    - Intersection:
        Return the interpolated intensity value in the volume at the exact 
        position of the considered point. If using this method, Radius should be 
        set to 0.
    - Non-Maximum Suppression:
        Select the voxel in the neighborhood that is a local maxima with the 
        largest intensity value.
    - Maximum:
        Select the voxel in the neighborhood with the largest intensity value. 
        This preferred method for datasets where the signal response (e.g. ink) 
        is expected to be brighter than the layer.
     - Minimum:
        Select the voxel in the neighborhood with the smallest intensity value.
    - Median w/ Averaging:
        Sorts the neighborhood by intensity and averages the middle 10% of 
        voxels.
    - Median w/o Averaging:
        Sorts the neighborhood by intensity and selects the median voxel.
    - Mean:
        Average all intensities in the neighborhood.
  Sample Direction: Limits the neighborhood based on voxel position
    - Omnidirectional:
        The neighborhood includes voxels in both the positive and negative 
        normal directions.
    - Positive:
        The neighborhood includes voxels in only the positive normal direction.
    - Negative:
        The neighborhood includes voxels in only the negative normal direction.

After selecting your rendering parameters, click the Generate Texture button to 
run the rendering process. Depending upon the size of the segmentation and the 
size of the neighborhood, this process may take a significant amount of time. 
Upon completion, the flattened render image for the selected segmentation will 
be shown in the Texture Viewer. If you are satisfied with the results, select 
"File->Save Texture" to save the results to the volume package. Note that there 
is currently a limit of one rendering per segmentation when saving to the volume 
package. 
  
You can also save the rendering to a variety of image formats using 
"File->Export Texture". Currently only JPG, TIF, and PNG formats are supported. 
Textured OBJ and PLY formats are coming soon.  